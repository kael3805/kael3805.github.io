

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=dark>



<head>
  <meta charset="UTF-8">
  <meta name="referrer" content="no-referrer">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Kael">
  <meta name="keywords" content="">
  
    <meta name="description" content="Elasticsearch 学习笔记简介 Elasticsearch（简称：ES） 是一个免费且开放的分布式搜索和分析引擎，适用于包括文本、数字、地理空间、结构化和非结构化数据等在内的所有类型的数据。Elasticsearch 在 Apache Lucene 的基础上开发而成，由 Elasticsearch N.V.（即现在的 Elastic）于 2010 年首次发布。Elasticsearch">
<meta property="og:type" content="article">
<meta property="og:title" content="Elasticsearch 学习笔记">
<meta property="og:url" content="https://kael.52dev.fun/2023/04/21/Elastic%20Search%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="码农笔记">
<meta property="og:description" content="Elasticsearch 学习笔记简介 Elasticsearch（简称：ES） 是一个免费且开放的分布式搜索和分析引擎，适用于包括文本、数字、地理空间、结构化和非结构化数据等在内的所有类型的数据。Elasticsearch 在 Apache Lucene 的基础上开发而成，由 Elasticsearch N.V.（即现在的 Elastic）于 2010 年首次发布。Elasticsearch">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/carl-d/blogimage/raw/master/docimage/202304210935440.jpeg">
<meta property="article:published_time" content="2023-04-21T01:31:25.000Z">
<meta property="article:modified_time" content="2023-04-21T01:47:36.726Z">
<meta property="article:author" content="Kael">
<meta property="article:tag" content="Elasticsearch">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://gitee.com/carl-d/blogimage/raw/master/docimage/202304210935440.jpeg">
  
  
  
  <title>Elasticsearch 学习笔记 - 码农笔记</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"kael.52dev.fun","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>码农笔记</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Elasticsearch 学习笔记"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-04-21 09:31" pubdate>
          2023年4月21日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          29k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          246 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Elasticsearch 学习笔记</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="Elasticsearch-学习笔记"><a href="#Elasticsearch-学习笔记" class="headerlink" title="Elasticsearch 学习笔记"></a>Elasticsearch 学习笔记</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote>
<p>Elasticsearch（简称：ES） 是一个免费且开放的分布式搜索和分析引擎，适用于包括文本、数字、地理空间、结构化和非结构化数据等在内的所有类型的数据。Elasticsearch 在 Apache Lucene 的基础上开发而成，由 Elasticsearch N.V.（即现在的 Elastic）于 2010 年首次发布。Elasticsearch 以其简单的 REST 风格 API、分布式特性、速度和可扩展性而闻名，是 Elastic Stack 的核心组件；Elastic Stack 是一套适用于数据采集、扩充、存储、分析和可视化的免费开源工具。人们通常将 Elastic Stack 称为 ELK Stack（代指 Elasticsearch、Logstash 和 Kibana），目前 Elastic Stack 包括一系列丰富的轻量型数据采集代理，这些代理统称为 Beats，可用来向 Elasticsearch 发送数据。</p>
<p>官方网站：<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/">https://www.elastic.co/cn/</a></p>
<p>官方英文文档：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/getting-started.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/getting-started.html</a></p>
<p>官方中文文档：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html">https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html</a></p>
</blockquote>
<h3 id="Elasticsearch-用途"><a href="#Elasticsearch-用途" class="headerlink" title="Elasticsearch 用途"></a>Elasticsearch 用途</h3><ul>
<li>应用程序搜索</li>
<li>网站搜索</li>
<li>企业搜索</li>
<li>日志处理和分析</li>
<li>基础设施指标和容器监测</li>
<li>应用程序性能监测</li>
<li>地理空间数据分析和可视化</li>
<li>安全分析</li>
<li>业务分析</li>
</ul>
<h3 id="Elasticsearch-基本概念"><a href="#Elasticsearch-基本概念" class="headerlink" title="Elasticsearch 基本概念"></a>Elasticsearch 基本概念</h3><ul>
<li><p>索引（Index）：索引是具有相同结构的文档集合。在 Elasticsearch 中，索引是个非常重要的内容，对于 Elasticsearch 的大部分操作都是基于索引来完成的。它类似于关系数据库中的数据库。每个索引可以包含多个文档和类型。索引可以分为分片，每个分片可以分布在不同的节点上。</p>
</li>
<li><p>类型（Type）：Elasticsearch 中的类型类似数据库中的表。但是从 7.0 版本开始，Elasticsearch 不再支持 Type 的概念，不同的类型使用单独的索引来管理。所有的文档类型都默认使用<code>_doc</code>。</p>
</li>
<li><p>文档（Document）：文档类似于关系数据库中的一行记录。每个文档都有一个唯一标识符（ID），并且有一个 JSON 格式的数据内容。</p>
</li>
<li><p>映射（Mapping）：映射定义了索引中每个字段的数据类型和属性。ElasticSearch 会根据映射将数据存储在倒排索引中。</p>
</li>
<li><p>倒排索引：ElasticSearch 使用倒排索引来实现文档搜索。它将文档中的每个单词都存储到一个排序后的列表中，并将单词所出现的文档 ID 与之关联。这样，就可以通过关键字来快速查找匹配的文档。</p>
<p>举例：比如搜索关键词“小米手机”，保存记录中有<code>1.南方小米、2.东北大米、3.小米手机</code>。</p>
<p>ES 会对搜索的关键词进行分词，分词后匹配如下：</p>
<table>
<thead>
<tr>
<th>关键词</th>
<th>ID</th>
</tr>
</thead>
<tbody><tr>
<td>小</td>
<td>1,3</td>
</tr>
<tr>
<td>米</td>
<td>1,2,3</td>
</tr>
<tr>
<td>手</td>
<td>3</td>
</tr>
<tr>
<td>机</td>
<td>3</td>
</tr>
</tbody></table>
<p>从表中，可以看到，每个分词对应着一组 ID。然后 ES 会对这些匹配的 ID 进行评分，即按照 ID 的出现次数。从分词表中可以看出 ID 为 3 的匹配次数最多。最终 ES 会按照评分从高到低排序查询出数据，即[3.小米手机, 1.南方小米, 2.大米]。</p>
</li>
<li><p>分片（shard）：分片是将一个索引（index）拆分成多个部分的过程，每个部分称为一个分片。每个分片包含部分索引数据和索引元数据，这些分片可以在不同的节点上存储和处理，从而提高性能和可扩展性。分片包含主分片和副本分片，每个索引默认都有一个主分片和一个副本分片，并且放到不同的节点上。</p>
<ul>
<li>主分片（primary shard）：主分片是索引的原始分片，包含索引的一部分数据。每个主分片在一个节点上维护，可以被分配到集群中的任何节点上。这有点儿类似关系型数据库的水平分库分表，或类似 Redis 的集群模式，通过减少单点存储的数据量来达到提高性能的目的。**<em>注意：主分片数量一旦确定就无法再修改了，如果必须要修改只能重新创建索引，并将原索引的数据迁移到新索引中。虽然 Elasticsearch 提供了自动迁移的 API，但如果数据量过大，迁移会非常耗时。因此，建议一开始就规划好分片数量，尽可能避免后期修改。</em>**</li>
<li>副本分片（replica shard）：副本分片是主分片的复制品，每个主分片可以有一个或多个副本。当主分片的数据发生变化，Elasticsearch 会自动将数据同步到副本分片上。当主分片失效，Elasticsearch 会自动选举一个副本分片作为主分片，以达到容错的目的。正常情况下，副本分片会作为只读分片提供查询。这有点类似关系型数据库的主从模式，通过主从达到读写分离的目的，当主节点故障，则从节点自动提升为主节点。</li>
</ul>
<p>主分片和副本分片被创建时，Elasticsearch 会自动将它们放到不同的节点上，以防止机器节点故障后，副本分片无法被提升为主分片。</p>
<p><strong>分片划分建议</strong></p>
<p>主分片的大小最好控制在 30GB 以内，即每个分片存储的数据不要超过 30G，并且主分片的最大数量最好不好超过 100 个。主分片的数量确定可以参考这个公式<code>预估索引数据大小 / 每个分片限制大小</code>。</p>
<p>比如：预计索引的数据有 500GB，每个索引控制在 30GB。</p>
<p>分片数量 &#x3D; 500 &#x2F; 30 &#x3D; 16</p>
<p>即：可以定义 16 个主分片。</p>
<p>这里只是一个参考，实际划分还要参考硬件性能、并发量等条件。另外，尽量避免单个索引的数量过大，如果数据量本身就很大，可以定义多个索引来存储。比如日志信息，日志是每时每刻都在产生的，可以设定一个时间范围，比如每个月的日志使用一个单独的索引，即索引定义为<code>logs_&lt;年&gt;_&lt;月&gt;</code>。这样做的好处是避免了单个索引的数据量过大，并且当集群扩展节点时，数据会分配到新的节点存储，这样也能达到平衡的目的。</p>
</li>
</ul>
<h2 id="安装-Elasticsearch"><a href="#安装-Elasticsearch" class="headerlink" title="安装 Elasticsearch"></a>安装 Elasticsearch</h2><blockquote>
<p>Elasticsearch 有简单安装和集群安装两种方式。如果只是想简单体验 Elasticsearch 的功能，可以下载一个 Elasticsearch 的安装包进行安装即可。或使用 Docker 镜像进行安装。</p>
<p>但在实际使用中，Elasticsearch 一般都使用的是集群环境。因此，本章节介绍怎么使用 Docker 搭建一个 Elasticsearch 的集群环境。使用 Docker 安装 Elasticsearch 集群需要先安装 Docker 和 Docker Compose 环境。</p>
<p>本次安装的 Elasticsearch 版本是 7.17.7，因为在安装 IK 分词器时发现，IK 分词器的版本只到 7.17.7。</p>
</blockquote>
<h3 id="安装前准备"><a href="#安装前准备" class="headerlink" title="安装前准备"></a>安装前准备</h3><p>使用 Docker 安装 Elasticsearch，需要先下载一个镜像，然后运行这个镜像。从镜像运行的容器中复制出 Elasticsearch 所需的配置文件。后面会以编排的形式将配置文件挂载上去。</p>
<ul>
<li><p>下载镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull elasticsearch:7.17.7<br></code></pre></td></tr></table></figure>
</li>
<li><p>使用镜像运行容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -d --name elasticsearch -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; elasticsearch:7.17.7<br></code></pre></td></tr></table></figure>
</li>
<li><p>查看运行的镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker ps -a<br></code></pre></td></tr></table></figure>

<p>命令执行结果如下：</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xl">-- console <span class="hljs-built_in">log</span> --<br>CONTAINER ID   IMAGE                       COMMAND                  CREATED          STATUS          PORTS                                                                                  NAMES<br><span class="hljs-number">3277</span><span class="hljs-function"><span class="hljs-title">e5f102ab</span>   elasticsearch:7.17.7        &quot;/tini -- /usr/local…&quot;   18 seconds ago   Up 13 seconds   0.0.0.0:9200-&gt;</span><span class="hljs-number">9200</span>/<span class="hljs-function"><span class="hljs-title">tcp</span>, :::9200-&gt;</span><span class="hljs-number">9200</span>/<span class="hljs-function"><span class="hljs-title">tcp</span>, 0.0.0.0:9300-&gt;</span><span class="hljs-number">9300</span>/<span class="hljs-function"><span class="hljs-title">tcp</span>, :::9300-&gt;</span><span class="hljs-number">9300</span>/tcp   elasticsearch<br></code></pre></td></tr></table></figure>
</li>
<li><p>进入容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker exec -it &lt;容器ID&gt; /bin/bash<br></code></pre></td></tr></table></figure>

<p><strong>重点：成功进入容器后需要查询几个关键的信息。</strong></p>
<ul>
<li><p>查询目录所属用户</p>
<p>使用<code>ll</code>命令查看当前目录，返回如下信息</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs tap">-- console log --<br>drwxrwxr-x <span class="hljs-number"> 1 </span>root          root    <span class="hljs-number"> 58 </span>Mar<span class="hljs-number"> 24 </span>02:33 ./<br>drwxr-xr-x <span class="hljs-number"> 1 </span>root          root    <span class="hljs-number"> 27 </span>Jan<span class="hljs-number"> 31 </span>05:40 ../<br>-rw-r--r-- <span class="hljs-number"> 1 </span>root          root   <span class="hljs-number"> 220 </span>Jan<span class="hljs-number"> 31 </span>05:40 .bash_logout<br>-rw-r--r-- <span class="hljs-number"> 1 </span>root          root  <span class="hljs-number"> 3771 </span>Jan<span class="hljs-number"> 31 </span>05:40 .bashrc<br>drwxrwxr-x <span class="hljs-number"> 3 </span>elasticsearch root    <span class="hljs-number"> 17 </span>Mar<span class="hljs-number"> 24 </span>02:33 .cache/<br>-rw-r--r-- <span class="hljs-number"> 1 </span>root          root   <span class="hljs-number"> 807 </span>Jan<span class="hljs-number"> 31 </span>05:40 .profile<br>-r--r--r-- <span class="hljs-number"> 1 </span>root          root  <span class="hljs-number"> 3860 </span>Jan<span class="hljs-number"> 31 </span>05:33 LICENSE.txt<br>-r--r--r-- <span class="hljs-number"> 1 </span>root          root<span class="hljs-number"> 642830 </span>Jan<span class="hljs-number"> 31 </span>05:35 NOTICE.txt<br>-r--r--r-- <span class="hljs-number"> 1 </span>root          root  <span class="hljs-number"> 2710 </span>Jan<span class="hljs-number"> 31 </span>05:33 README.asciidoc<br>drwxrwxr-x <span class="hljs-number"> 1 </span>elasticsearch root     <span class="hljs-number"> 6 </span>Jan<span class="hljs-number"> 31 </span>05:39 bin/<br>drwxrwxr-x <span class="hljs-number"> 1 </span>elasticsearch root    <span class="hljs-number"> 36 </span>Mar<span class="hljs-number"> 24 </span>02:33 config/<br>drwxrwxr-x <span class="hljs-number"> 1 </span>elasticsearch root    <span class="hljs-number"> 19 </span>Mar<span class="hljs-number"> 24 </span>02:33 data/<br>dr-xr-xr-x <span class="hljs-number"> 1 </span>root          root    <span class="hljs-number"> 17 </span>Jan<span class="hljs-number"> 31 </span>05:38 jdk/<br>dr-xr-xr-x <span class="hljs-number"> 3 </span>root          root  <span class="hljs-number"> 4096 </span>Jan<span class="hljs-number"> 31 </span>05:38 lib/<br>drwxrwxr-x <span class="hljs-number"> 1 </span>elasticsearch root    <span class="hljs-number"> 37 </span>Mar<span class="hljs-number"> 24 </span>02:33 logs/<br>dr-xr-xr-x<span class="hljs-number"> 61 </span>root          root  <span class="hljs-number"> 4096 </span>Jan<span class="hljs-number"> 31 </span>05:38 modules/<br>drwxrwxr-x <span class="hljs-number"> 1 </span>elasticsearch root     <span class="hljs-number"> 6 </span>Jan<span class="hljs-number"> 31 </span>05:35 plugins/<br></code></pre></td></tr></table></figure>

<p>这里主要关注三个重要的信息，config、data、logs 这三个目录的所属用户是<code>elasticsearch</code>。这里是个大坑，后面我们在编排服务时，挂载目录的所属用户要和这里的所属用户保持一致，否则启动会提示权限错误。</p>
</li>
<li><p>查看用户的 id 信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">id elasticsearch<br></code></pre></td></tr></table></figure>

<p>命令返回结果如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">--<span class="hljs-built_in"> console </span>log --<br><span class="hljs-attribute">uid</span>=1000(elasticsearch) <span class="hljs-attribute">gid</span>=1000(elasticsearch) <span class="hljs-attribute">groups</span>=1000(elasticsearch),0(root)<br></code></pre></td></tr></table></figure>

<p>这里的 uid 的值是 1000，这个值一定要记好。后面会用到这个值。</p>
</li>
<li><p>查询当前路径</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">pwd<br></code></pre></td></tr></table></figure>

<p>命令返回结果如下：</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs arcade">-- <span class="hljs-built_in">console</span> <span class="hljs-built_in">log</span> --<br><span class="hljs-regexp">/usr/</span>share/elasticsearch<br></code></pre></td></tr></table></figure>

<p>这个路径也要记录下来，后面也会用到。确定好路径之后，可以使用<code>exit</code>命令退出容器。</p>
</li>
</ul>
</li>
<li><p>复制配置文件目录到宿主机</p>
<p>这一步是将容器下的配置目录复制到宿主机上，这里就用到了前面查询到的<code>/usr/share/elasticsearch</code>路径。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">新建用于保存配置文件的临时目录</span><br>mkdir -p ~/elasticsearch/example<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">复制容器中的配置文件到宿主机</span><br>docker cp &lt;容器ID&gt;:/usr/share/elasticsearch/config ~/elasticsearch/example/config<br></code></pre></td></tr></table></figure>
</li>
<li><p>停止并删除 Elasticsearch 容器</p>
<p>前面启动容器只是为了获取配置文件，配置文件复制出来以后，容器就可以停止了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker rm $(docker stop &lt;容器ID&gt;)<br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="修改-elasticsearch-yml-配置文件"><a href="#修改-elasticsearch-yml-配置文件" class="headerlink" title="修改 elasticsearch.yml 配置文件"></a>修改 elasticsearch.yml 配置文件</h3><p>单节点启动的配置文件比较简单，我们需要将其修改成集群模式的配置。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 集群名称，所有集群节点的名称要一致。</span><br><span class="hljs-attr">cluster.name:</span> <span class="hljs-string">es-cluster</span><br><span class="hljs-comment"># 节点名称，每个节点使用不同的命名，比如：es-node1、es-node2、es-node3</span><br><span class="hljs-attr">node.name:</span> <span class="hljs-string">es-node1</span><br><span class="hljs-comment"># 是否可以成为master节点</span><br><span class="hljs-attr">node.master:</span> <span class="hljs-literal">true</span><br><span class="hljs-comment"># 是否允许该节点存储数据,默认开启</span><br><span class="hljs-attr">node.data:</span> <span class="hljs-literal">true</span><br><span class="hljs-comment"># 网络绑定</span><br><span class="hljs-attr">network.host:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><br><span class="hljs-comment"># 设置对外服务的http端口</span><br><span class="hljs-attr">http.port:</span> <span class="hljs-number">9200</span><br><span class="hljs-comment"># 设置节点间交互的tcp端口</span><br><span class="hljs-attr">transport.port:</span> <span class="hljs-number">9300</span><br><span class="hljs-comment"># 集群发现，此处配置除了自己以外的其他节点。</span><br><span class="hljs-attr">discovery.seed_hosts:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">es-node2</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">es-node3</span><br><span class="hljs-comment"># 指定可以成为 mater 节点的 hostname 或者 ip，这些配置将会在第一次选举中进行计算</span><br><span class="hljs-attr">cluster.initial_master_nodes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">es-node1</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">es-node2</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">es-node3</span><br><span class="hljs-comment"># 支持跨域访问</span><br><span class="hljs-attr">http.cors.enabled:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">http.cors.allow-origin:</span> <span class="hljs-string">&quot;*&quot;</span><br><span class="hljs-comment"># 安全认证</span><br><span class="hljs-attr">xpack.security.enabled:</span> <span class="hljs-literal">false</span><br><span class="hljs-comment">#http.cors.allow-headers: &quot;Authorization&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="编排服务"><a href="#编排服务" class="headerlink" title="编排服务"></a>编排服务</h3><p>由于搭建的是集群，所以最好是将每个节点的配置、数据、日志等分开保存。</p>
<ul>
<li><p>创建主从节点目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">分别创建节点的数据文件目录</span><br>mkdir -p ~/elasticsearch/node1/data ~/elasticsearch/node2/data ~/elasticsearch/node3/data<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">分别创建三个节点的日志文件目录</span><br>mkdir -p ~/elasticsearch/node1/logs ~/elasticsearch/node2/config ~/elasticsearch/node3/logs<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建插件目录，由于插件是各个节点共享的，因此只创建一个目录即可。</span><br>mkdir -p ～/elasticsearch/plugins<br></code></pre></td></tr></table></figure>
</li>
<li><p>复制上一小节编写好的配置文件到节点目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">cp -r ~/elasticsearch/example/config ~/elasticsearch/node1/config<br>cp -r ~/elasticsearch/example/config ~/elasticsearch/node2/config<br>cp -r ~/elasticsearch/example/config ~/elasticsearch/node3/config<br></code></pre></td></tr></table></figure>

<p>复制完成后，分别修改三个节点的配置。主要的修改项如下：</p>
<ul>
<li>node.name：集群节点名称，它将作为节点的标识存在，最好是每个节点使用不同的名称。</li>
<li>discovery.seed_hosts：集群节点发现，此处配置除了自己以外的其他节点。可以是 hostname 或 IP:9300，这里的 9300 是集群交互端口，不写会默认使用 9300，如果你使用的是 IP 地址，建议还是写上。</li>
</ul>
</li>
<li><p>给新建的目录授权</p>
<p>这里为了后续的操作方便，可以直接给<code>elasticsearch</code>目录授权。另外还需要给新建的目录指定所属用户，这里就用到了前面查询到的 uid。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">设置权限</span><br>chmod -R o+xrw ~/elasticsearch<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">指定data目录的所属用户</span><br>chown 1000 ~/elasticsearch/node1/data<br>chown 1000 ~/elasticsearch/node2/data<br>chown 1000 ~/elasticsearch/node3/data<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">指定logs目录的所属用户</span><br>chown 1000 ~/elasticsearch/node1/logs<br>chown 1000 ~/elasticsearch/node2/logs<br>chown 1000 ~/elasticsearch/node3/logs<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">指定日志目录的所属用户</span><br>chown 1000 ~/elasticsearch/node1/config<br>chown 1000 ~/elasticsearch/node2/config<br>chown 1000 ~/elasticsearch/node3/config<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">指定插件目录的所属用户</span><br>chown 1000 -R ～/elasticsearch/plugins<br></code></pre></td></tr></table></figure>

<p>此处使用的是递归授权，即 elasticsearch 目录及其子目录和文件，授予其他用户的执行和读写权限。另外，使用 chown 指定所属用户之后，使用<code>ll</code>命令查看时，发现目录的所属用户并不是<code>elasticsearch</code>。这是因为宿主机上不存在这个用户，但是它会有一个用户与容器中的<code>elasticsearch</code>用户对应。因此，只要保证宿主机的用户和容器中的用户<code>uid</code>一致就可以了。</p>
</li>
<li><p>新建 Docker 网络</p>
<p>这一步的目的是让后面创建的所有容器都基于这个网络运行。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker network create -d bridge elasticsearch_network<br></code></pre></td></tr></table></figure>

<p>此处创建了一个桥接网络，后面的 Elasticsearch 和 Kibana 编排时，都使用这个网络。这样容器之间就可以互联互通了。如若不然，就必须将所有的服务都写入同一个编排文件中。</p>
<p>如果想要查看已经创建的网络，可以使用下面的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker network inspect &lt;网络名称&gt;<br></code></pre></td></tr></table></figure>
</li>
<li><p>编写编排文件</p>
<p>在<code>elasticsearch</code>目录下新建一个<code>elasticsearch-compose.yml</code>文件。编写内容如下：</p>
<p><code>elasticsearch-compose.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;3&quot;</span><br><span class="hljs-attr">services:</span><br>    <span class="hljs-attr">es-node1:</span><br>        <span class="hljs-attr">container_name:</span> <span class="hljs-string">es-node1</span><br>        <span class="hljs-attr">hostname:</span> <span class="hljs-string">es-node1</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">elasticsearch:7.17.7</span><br>        <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>        <span class="hljs-attr">user:</span> <span class="hljs-string">root</span><br>        <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-number">9200</span><span class="hljs-string">:9200</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-number">9300</span><span class="hljs-string">:9300</span><br>        <span class="hljs-comment"># 指定使用的网络</span><br>        <span class="hljs-attr">networks:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">elasticsearch_network</span><br>        <span class="hljs-attr">volumes:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">~/elasticsearch/node1/config:/usr/share/elasticsearch/config</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">~/elasticsearch/node1/data:/usr/share/elasticsearch/data</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">~/elasticsearch/node1/logs:/usr/share/elasticsearch/logs</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">~/elasticsearch/plugins:/usr/share/elasticsearch/plugins</span><br>        <span class="hljs-attr">environment:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;TZ=Asia/Shanghai&quot;</span><br>        <span class="hljs-attr">privileged:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">stdin_open:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">tty:</span> <span class="hljs-literal">true</span><br><br>    <span class="hljs-attr">es-node2:</span><br>        <span class="hljs-attr">container_name:</span> <span class="hljs-string">es-node2</span><br>        <span class="hljs-attr">hostname:</span> <span class="hljs-string">es-node2</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">elasticsearch:7.17.7</span><br>        <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>        <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-number">9201</span><span class="hljs-string">:9200</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-number">9301</span><span class="hljs-string">:9300</span><br>        <span class="hljs-comment"># 指定使用的网络</span><br>        <span class="hljs-attr">networks:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">elasticsearch_network</span><br>        <span class="hljs-attr">volumes:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">~/elasticsearch/node2/config:/usr/share/elasticsearch/config</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">~/elasticsearch/node2/data:/usr/share/elasticsearch/data</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">~/elasticsearch/node2/logs:/usr/share/elasticsearch/logs</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">~/elasticsearch/plugins:/usr/share/elasticsearch/plugins</span><br>        <span class="hljs-attr">environment:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;TZ=Asia/Shanghai&quot;</span><br>        <span class="hljs-attr">privileged:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">stdin_open:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">tty:</span> <span class="hljs-literal">true</span><br><br>    <span class="hljs-attr">es-node3:</span><br>        <span class="hljs-attr">container_name:</span> <span class="hljs-string">es-node3</span><br>        <span class="hljs-attr">hostname:</span> <span class="hljs-string">es-node3</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">elasticsearch:7.17.7</span><br>        <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>        <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-number">9202</span><span class="hljs-string">:9200</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-number">9302</span><span class="hljs-string">:9300</span><br>        <span class="hljs-comment"># 指定使用的网络</span><br>        <span class="hljs-attr">networks:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">elasticsearch_network</span><br>        <span class="hljs-attr">volumes:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">~/elasticsearch/node3/config:/usr/share/elasticsearch/config</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">~/elasticsearch/node3/data:/usr/share/elasticsearch/data</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">~/elasticsearch/node3/logs:/usr/share/elasticsearch/logs</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">~/elasticsearch/plugins:/usr/share/elasticsearch/plugins</span><br>        <span class="hljs-attr">environment:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;TZ=Asia/Shanghai&quot;</span><br>        <span class="hljs-attr">privileged:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">stdin_open:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">tty:</span> <span class="hljs-literal">true</span><br><br><span class="hljs-comment"># 开启外部网络访问，此处开启的是一开始创建好的桥接网络</span><br><span class="hljs-attr">networks:</span><br>    <span class="hljs-attr">elasticsearch_network:</span><br>        <span class="hljs-attr">external:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<p><strong><em>注意：JVM 内存的配置不要设置的太小，否则集群无法启动。我这里配置的是最低要求，实际使用时，可以根据情况自行调整。一般调整策略为：(宿主机总内存 &#x2F; 实例数量 &#x2F; 2) + 1，计算结果取整数。比如宿主机内存是 8G，部署了 3 个节点实例，实际计算 2.3333，取整数为 2，则我这里每个节点的最大内存不要超过 2GB。最小内存取最大内存的一半即可，但是不要低于 512M。</em></strong></p>
</li>
</ul>
<h3 id="启动集群"><a href="#启动集群" class="headerlink" title="启动集群"></a>启动集群</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker-compose -f elasticsearch-compose.yml up -d<br></code></pre></td></tr></table></figure>

<p>启动完成后，分别使用 9200、9201、9202 三个端口访问 Elasticsearch。如果都能正常访问，则说明搭建成功。也可以访问下面的地址来查看集群状态。</p>
<p><code>http://&lt;IP&gt;:&lt;端口&gt;/_cluster/health?pretty</code>，成功访问后返回如下信息：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;cluster_name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;es-cluster&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;green&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;timed_out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;number_of_nodes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;number_of_data_nodes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;active_primary_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;active_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;relocating_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;initializing_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;unassigned_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;delayed_unassigned_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;number_of_pending_tasks&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;number_of_in_flight_fetch&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;task_max_waiting_in_queue_millis&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;active_shards_percent_as_number&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>其中<code>&quot;status&quot;: &quot;green&quot;</code>是指集群状态正常。<code>number_of_nodes</code>是指当前活动的节点数。</p>
<h2 id="安装-Kibana"><a href="#安装-Kibana" class="headerlink" title="安装 Kibana"></a>安装 Kibana</h2><blockquote>
<p>Kibana 是一个开源的分析与可视化平台，它可用于管理 Elasticsearch。</p>
<p>注意：Kibana 的版本最好和 Elasticsearch 的版本保持一致。</p>
</blockquote>
<h3 id="安装前准备-1"><a href="#安装前准备-1" class="headerlink" title="安装前准备"></a>安装前准备</h3><p>此处的步骤和安装 Elasticsearch 时的步骤，大致相同，都需要先运行一个临时容器，然后从中复制出配置文件。</p>
<ul>
<li><p>下载 Kibana 镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">再次声明，Kibana 的版本最好与 ElasticSearch 保持一致。</span><br>docker pull kibana:7.17.7<br></code></pre></td></tr></table></figure>
</li>
<li><p>运行一个临时容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -d --name kibana -p 5601:5601 kibana:7.17.7<br></code></pre></td></tr></table></figure>
</li>
<li><p>进入容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker exec -it &lt;容器ID&gt; /bin/bash<br></code></pre></td></tr></table></figure>

<ul>
<li><p>查看目录及权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">有些容器不能使用 ll 命令，如果不能用，可以使用 <span class="hljs-built_in">ls</span> -l</span><br>ls -l<br></code></pre></td></tr></table></figure>

<p>命令执行结果如下：</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs tap">-- console log --<br>total 1152<br>-rw-rw-r--  <span class="hljs-number"> 1 </span>kibana root   <span class="hljs-number"> 3860 </span>Jan<span class="hljs-number"> 30 </span>12:30 LICENSE.txt<br>-rw-rw-r--  <span class="hljs-number"> 1 </span>kibana root<span class="hljs-number"> 1128786 </span>Jan<span class="hljs-number"> 30 </span>12:30 NOTICE.txt<br>-rw-rw-r--  <span class="hljs-number"> 1 </span>kibana root   <span class="hljs-number"> 3970 </span>Jan<span class="hljs-number"> 30 </span>12:30 README.txt<br>drwxrwxr-x  <span class="hljs-number"> 2 </span>kibana root     <span class="hljs-number"> 94 </span>Jan<span class="hljs-number"> 30 </span>12:30 bin<br>drwxrwxr-x  <span class="hljs-number"> 1 </span>kibana root     <span class="hljs-number"> 24 </span>Jan<span class="hljs-number"> 30 </span>12:44 config<br>drwxrwxr-x  <span class="hljs-number"> 1 </span>kibana root     <span class="hljs-number"> 18 </span>Mar<span class="hljs-number"> 24 </span>04:10 data<br>drwxrwxr-x  <span class="hljs-number"> 6 </span>kibana root    <span class="hljs-number"> 108 </span>Jan<span class="hljs-number"> 30 </span>12:30 node<br>drwxrwxr-x<span class="hljs-number"> 682 </span>kibana root  <span class="hljs-number"> 20480 </span>Jan<span class="hljs-number"> 30 </span>12:30 node_modules<br>-rw-rw-r--  <span class="hljs-number"> 1 </span>kibana root    <span class="hljs-number"> 740 </span>Jan<span class="hljs-number"> 30 </span>12:30 package.json<br>drwxrwxr-x  <span class="hljs-number"> 2 </span>kibana root      <span class="hljs-number"> 6 </span>Jan<span class="hljs-number"> 30 </span>12:30 plugins<br>drwxrwxr-x  <span class="hljs-number"> 9 </span>kibana root    <span class="hljs-number"> 131 </span>Jan<span class="hljs-number"> 30 </span>12:30 src<br>drwxrwxr-x  <span class="hljs-number"> 3 </span>kibana root     <span class="hljs-number"> 79 </span>Jan<span class="hljs-number"> 30 </span>12:30 x-pack<br></code></pre></td></tr></table></figure>
</li>
<li><p>查看目录的完整路径</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">pwd<br></code></pre></td></tr></table></figure>

<p>命令执行结果如下：</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs arcade">-- <span class="hljs-built_in">console</span> <span class="hljs-built_in">log</span> --<br><span class="hljs-regexp">/usr/</span>share/kibana<br></code></pre></td></tr></table></figure>
</li>
<li><p>查看 kibana 的 uid</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">id kibana<br></code></pre></td></tr></table></figure>

<p>命令执行结果如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">--<span class="hljs-built_in"> console </span>log --<br><span class="hljs-attribute">uid</span>=1000(kibana) <span class="hljs-attribute">gid</span>=1000(kibana) <span class="hljs-attribute">groups</span>=1000(kibana),0(root)<br></code></pre></td></tr></table></figure></li>
</ul>
<p>将上面查询到的结果记录下来，后面会用到。</p>
</li>
<li><p>复制配置文件目录到宿主机</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">新建用于保存配置文件的临时目录</span><br>mkdir -p ~/kibana/example<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">复制容器中的配置文件目录到宿主机临时目录</span><br>docker cp &lt;容器ID&gt;:/usr/share/kibana/config ~/kibana/example/config<br></code></pre></td></tr></table></figure>

<p>复制完配置文件之后，临时容器就可以删除了，否则后面再启动新实例的时候，会有端口冲突。</p>
</li>
</ul>
<h3 id="修改-kibana-yml-配置文件"><a href="#修改-kibana-yml-配置文件" class="headerlink" title="修改 kibana.yml 配置文件"></a>修改 kibana.yml 配置文件</h3><p><code>kibana.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># ---------- 服务配置 ----------</span><br><span class="hljs-comment"># Kibana 服务名</span><br><span class="hljs-attr">server.name:</span> <span class="hljs-string">kibana</span><br><span class="hljs-comment"># 服务IP</span><br><span class="hljs-attr">server.host:</span> <span class="hljs-string">&quot;0.0.0.0&quot;</span><br><span class="hljs-comment"># 服务端口</span><br><span class="hljs-attr">server.port:</span> <span class="hljs-number">5601</span><br><span class="hljs-comment"># Kibana 停止超时时间，当 Kibana 需要关闭或重启时，需要等待 ES 确认。这里是等待的多少秒后关闭。</span><br><span class="hljs-comment"># 如果 ES 集群响应缓慢，这里设置的时间最好长一点。因为超过这个时间，Kibana就不会再等待了。</span><br><span class="hljs-comment"># 当然也不要太长。默认是5秒。</span><br><span class="hljs-attr">server.shutdownTimeout:</span> <span class="hljs-string">&quot;5s&quot;</span><br><br><span class="hljs-comment"># ---------- Elasticsearch ----------</span><br><span class="hljs-comment"># 设置 Elasticsearch 集群主机列表</span><br><span class="hljs-comment"># 如果编排 ES 服务时指定了 hostname，则这里可以用 hostname，否则可以使用IP地址。</span><br><span class="hljs-comment"># 如果使用的是宿主机IP，则这里的端口是容器对外暴露的端口。否则为容器内端口。</span><br><span class="hljs-attr">elasticsearch.hosts:</span><br>    [<span class="hljs-string">&quot;http://es-node1:9200&quot;</span>, <span class="hljs-string">&quot;http://es-node2:9200&quot;</span>, <span class="hljs-string">&quot;http://es-node3:9200&quot;</span>]<br><span class="hljs-comment"># 这个配置项，基于 Docker 部署会有。即：开启对容器内 ES 的监控。默认值为 true</span><br><span class="hljs-attr">monitoring.ui.container.elasticsearch.enabled:</span> <span class="hljs-literal">true</span><br><br><span class="hljs-comment"># ---------- 其他配置 ----------</span><br><span class="hljs-comment"># 国际化，这里用的 Docker 镜像已经集成了语言包。如果是裸机安装，需要先安装语言包，才能国际化。</span><br><span class="hljs-attr">i18n.locale:</span> <span class="hljs-string">&quot;zh-CN&quot;</span><br></code></pre></td></tr></table></figure>

<p>Kibana 的配置项很多，这里只列举了一些关键参数。如果想要使用其他相关功能，可以查阅官方文档。</p>
<h3 id="编排服务-1"><a href="#编排服务-1" class="headerlink" title="编排服务"></a>编排服务</h3><ul>
<li><p>创建相关目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">创建数据文件目录</span><br>mkdir -p ~/kibana/data<br></code></pre></td></tr></table></figure>
</li>
<li><p>复制编写好的配置文件到正式目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cp -r ~/kibana/example/config ~/kibana/config<br></code></pre></td></tr></table></figure>
</li>
<li><p>给目录授权</p>
<p>这一步可以借鉴前面的 Elasticsearch 授权说明。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">给目录授权</span><br>chmod -R o+xrw ~/kibana<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">指定所属用户</span><br>chown 1000 ~/kibana/config<br>chown 1000 ~/kibana/data<br></code></pre></td></tr></table></figure>
</li>
<li><p>查看已经运行的 Elasticsearch 容器的网络名</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker inspect &lt;容器ID&gt; --format=&#x27;&#123;&#123;range $key,$value:=.NetworkSettings.Networks&#125;&#125;&#123;&#123;$key&#125;&#125; &#123;&#123;end&#125;&#125;&#x27;<br></code></pre></td></tr></table></figure>

<p>命令执行结果如下：</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs arcade">-- <span class="hljs-built_in">console</span> <span class="hljs-built_in">log</span> --<br>elasticsearch_default<br></code></pre></td></tr></table></figure>

<p>在书写编排文件时，要让 kibana 加入到这个网络，否则无法使用 hostname 访问集群节点。</p>
</li>
<li><p>编写编排文件</p>
<p>在<code>kibana</code>目录下新建一个<code>kibana-compose.yml</code>文件，编写内容如下：</p>
<p><code>kibana-compose.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;3&quot;</span><br><span class="hljs-attr">services:</span><br>    <span class="hljs-attr">kibana:</span><br>        <span class="hljs-attr">container_name:</span> <span class="hljs-string">kibana</span><br>        <span class="hljs-attr">hostname:</span> <span class="hljs-string">kibana</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">kibana:7.17.7</span><br>        <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>        <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-number">5601</span><span class="hljs-string">:5601</span><br>        <span class="hljs-comment"># 配置使用的网络</span><br>        <span class="hljs-attr">networks:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">elasticsearch_network</span><br>        <span class="hljs-attr">volumes:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">~/kibana/config:/usr/share/kibana/config</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">~/kibana/data:/usr/share/kibana/data</span><br>        <span class="hljs-attr">environment:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;TZ=Asia/Shanghai&quot;</span><br>        <span class="hljs-attr">privileged:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">stdin_open:</span> <span class="hljs-literal">true</span><br><br><span class="hljs-comment"># 开启外部网络访问，此处开启的是一开始创建好的桥接网络</span><br><span class="hljs-attr">networks:</span><br>    <span class="hljs-attr">elasticsearch_network:</span><br>        <span class="hljs-attr">external:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="启动-kibana"><a href="#启动-kibana" class="headerlink" title="启动 kibana"></a>启动 kibana</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker-compose -f kibana-compose.yml up -d<br></code></pre></td></tr></table></figure>

<p>容器创建后，可以使用下面的命令查看是否启动成功。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">查看容器运行状态，如果 STATUS 始终是 UP，则说明容器启动成功。</span><br>docker ps -a<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看容器运行日志，如果没有报错信息，则说明 Kibana 运行良好。</span><br>docker logs -f &lt;容器ID&gt;<br></code></pre></td></tr></table></figure>

<p>确保一切正常之后，在浏览器输入：http:&#x2F;&#x2F;&lt;IP 地址&gt;:5061&#x2F;，就可以访问 Kibana 管理界面了。</p>
<h3 id="新建工作区"><a href="#新建工作区" class="headerlink" title="新建工作区"></a>新建工作区</h3><blockquote>
<p>新建工作区的目的是便于管理。当多个项目使用同一个 Elasticsearch 时，可以通过新建工作区来隔离。</p>
</blockquote>
<p>进入<code>菜单/Management/Stack Management</code>，在新打开的页面中找到<code>Kibana</code>标签下的<code>工作区</code>选项。点击右上角的<code>创建工作区</code>按钮。按照表单要求填写即可。</p>
<h3 id="开发工具"><a href="#开发工具" class="headerlink" title="开发工具"></a>开发工具</h3><blockquote>
<p>Kibana 提供了一个非常好用的开发工具。日常的一些 ES 操作都可以在上面完成。</p>
</blockquote>
<p>开发工具位置：<code>菜单/Management/开发工具</code>。</p>
<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><blockquote>
<p>索引对于 Elasticsearch 存储来说是最基本的单元。所有的数据都是存储在某个索引上的。</p>
</blockquote>
<h3 id="新建索引"><a href="#新建索引" class="headerlink" title="新建索引"></a>新建索引</h3><h4 id="简单索引创建"><a href="#简单索引创建" class="headerlink" title="简单索引创建"></a>简单索引创建</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /demo_user_info<br></code></pre></td></tr></table></figure>

<p>命令执行结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;acknowledged&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;shards_acknowledged&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;index&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;demo_user_info&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>此时我们就创建了一个名为<code>demo_user_info</code>的索引。</p>
<p>这里需要注意，一个工作区内不能出现同名的索引。如果我们使用上面的指令执行多次，那么从第二次开始会报错。另外，索引从操作上来将不是必须提前创建的，我们也可以在创建文档的时候创建。比如下面这样：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /demo_user_info/_doc<br>&#123;<br>	userName: &quot;hello&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>此时，Elasticsearch 会自动帮我们创建一个<code>demo_user_info</code>的索引，并往索引中插入一条数据。</p>
<h4 id="创建索引并设置分片和副本"><a href="#创建索引并设置分片和副本" class="headerlink" title="创建索引并设置分片和副本"></a>创建索引并设置分片和副本</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /demo_user_info<br>&#123;<br>  &quot;settings&quot;: &#123;<br>    &quot;number_of_shards&quot;: 2,<br>    &quot;number_of_replicas&quot;: 3<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>参数说明：</p>
<ul>
<li>number_of_shards：分片数量</li>
<li>number*of_replicas：副本数量，这里需要说明的是，副本总数量 &#x3D; 分片数量 * 设定的副本数量。比如：分片数量为 2，副本数量为 3，则副本总数量 &#x3D; 2 _ 3 &#x3D; 6 个。由此可以看出，这里指定的副本数量是指每个主分片有几个副本。</li>
</ul>
<h3 id="修改索引"><a href="#修改索引" class="headerlink" title="修改索引"></a>修改索引</h3><blockquote>
<p>索引不能修改主分片数量，其他修改可以通过相应的指令来修改。</p>
</blockquote>
<p><strong>修改副本数量</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /demo_user_info/_settings<br>&#123;<br>  &quot;settings&quot;: &#123;<br>    &quot;number_of_replicas&quot;: 4<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>修改映射</strong></p>
<p>以修改<code>userName</code>为例。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /demo_user_info/_mapping<br>&#123;<br>  &quot;properties&quot;: &#123;<br>    &quot;userName&quot;: &#123;<br>      &quot;type&quot;: &quot;keyword&quot;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">DELETE /my-index<br></code></pre></td></tr></table></figure>

<h3 id="迁移分片"><a href="#迁移分片" class="headerlink" title="迁移分片"></a>迁移分片</h3><p>对于索引不能修改的设置，可以通过新建索引，然后进行索引迁移的办法来实现。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs http">POST _reindex<br>&#123;<br>  &quot;source&quot;: &#123;<br>    &quot;index&quot;: &quot;old-index&quot;<br>  &#125;,<br>  &quot;dest&quot;: &#123;<br>    &quot;index&quot;: &quot;new-index&quot;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>使用举例</strong></p>
<ul>
<li><p>关闭索引的写操作</p>
<p>关闭写操作的目的是为了在迁移的过程中，防止有新的写入，导致迁移后的数据不完整。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /demo_user_info/_settings<br>&#123;<br>  &quot;blocks.write&quot;: true<br>&#125;<br></code></pre></td></tr></table></figure>

<p>参数说明：</p>
<ul>
<li><code>blocks.write</code>：写入锁。true-上锁；false-解锁。</li>
</ul>
</li>
<li><p>创建新索引</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /demo_user_info-2<br>&#123;<br>  &quot;settings&quot;: &#123;<br>    &quot;number_of_shards&quot;: 1,<br>    &quot;number_of_replicas&quot;: 1<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>迁移数据到新索引</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs http">POST _reindex<br>&#123;<br>  &quot;source&quot;: &#123;<br>    &quot;index&quot;: &quot;demo_user_info&quot;<br>  &#125;,<br>  &quot;dest&quot;: &#123;<br>    &quot;index&quot;: &quot;demo_user_info-2&quot;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>数据迁移完毕后，测试没有问题再删除旧的索引。</p>
</li>
</ul>
<h3 id="索引别名"><a href="#索引别名" class="headerlink" title="索引别名"></a>索引别名</h3><blockquote>
<p>索引别名是一个可以指向多个索引的别名，它允许用户使用别名来查询索引，这在索引迁移和合并查询时非常有效。但是需要注意，一对多的别名在读写时，一方面性能不好，另一方面可能导致数据不一致。因此，除非必要，否则尽可能使用一对一的别名。</p>
</blockquote>
<p>还是以上面的索引迁移为例，我们可以在一开始设计索引时就定义好一个别名，比如<code>user_info</code>，它指向一个具体的索引<code>demo_user_info</code>。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs http">POST /_aliases<br>&#123;<br>  &quot;actions&quot;: [<br>    &#123;<br>      &quot;add&quot;: &#123;<br>        &quot;index&quot;: &quot;demo_user_info&quot;,<br>        &quot;alias&quot;: &quot;user_info&quot;<br>      &#125;<br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>待数据迁移完毕后，将别名指向新的索引。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell">POST /_aliases<br>&#123;<br>  &quot;actions&quot;: [<br>    &#123;<br>      &quot;remove&quot;: &#123;<br>        &quot;index&quot;: &quot;demo_user_info&quot;,<br>        &quot;alias&quot;: &quot;user_info&quot;<br>      &#125;<br>    &#125;,<br>    &#123;<br>      &quot;add&quot;: &#123;<br>        &quot;index&quot;: &quot;demo_user_info-2&quot;,<br>        &quot;alias&quot;: &quot;user_info&quot;<br>      &#125;<br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这样，我们在查询索引时，就可以一直使用别名<code>user_info</code>来查询。避免索引迁移后进行大量的修改。</p>
<h2 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h2><blockquote>
<p>Elasticsearch 的映射（Mapping）是指用于定义索引中字段的数据类型、分词器等属性的结构。映射由多个字段映射组成，每个字段映射定义了一个字段的名称、数据类型、分词器、索引方式、存储方式等属性。映射在索引创建时定义，可以用于约束和规范数据，以提高搜索效率和精度。</p>
</blockquote>
<p>在 Elasticsearch 中，每个索引都有一个映射，映射中包含了索引中所有字段的定义。下面是一个映射的示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;mappings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;text&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;text&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;author&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;date&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>在这个映射中，包含了 4 个字段映射：</p>
<ul>
<li>title：文档标题字段，数据类型为 text。</li>
<li>content：文档内容字段，数据类型为 text。</li>
<li>author：作者字段，数据类型为 keyword。</li>
<li>timestamp：时间戳字段，数据类型为 date。</li>
</ul>
<p>每个字段映射可以包含多个属性，常用的属性包括：</p>
<ul>
<li>type：字段的数据类型，例如 text、keyword、date 等。</li>
<li>analyzer：用于对文本字段进行分词的分词器。</li>
<li>index：指定字段是否需要被索引，例如设置为 false 的字段不会被索引。</li>
<li>store：指定字段是否需要被存储，例如设置为 true 的字段会被存储在磁盘上，方便进行检索。</li>
<li>format：指定日期字段的格式。</li>
</ul>
<p>映射的作用主要有两个：</p>
<ol>
<li>约束数据：映射可以规范字段的数据类型、分词器等属性，从而约束数据的输入和格式，避免输入错误或无效数据的出现，提高搜索的准确性和精度。</li>
<li>提高搜索效率：映射可以指定字段的索引方式、存储方式等属性，从而提高搜索效率和速度，避免不必要的计算和 IO 操作。</li>
</ol>
<p>需要注意的是，和主分片一样，映射一旦定义后，就不能够再修改。因此，在设计映射时需要考虑到数据的需求和未来的扩展性，避免在后期需要修改映射的情况。如果需要修改映射并且保证每个文档都有新的映射，只能够通过重新创建索引的方式来实现。</p>
<h3 id="创建映射"><a href="#创建映射" class="headerlink" title="创建映射"></a>创建映射</h3><blockquote>
<p>通常情况下，映射会在创建索引时一起被创建出来。但如果已经有索引了，也可以再次创建，只不过新增的映射不会作用在历史数据上。</p>
</blockquote>
<ul>
<li><p>创建索引时同步创建映射</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /my-index<br>&#123;<br>  &quot;mappings&quot;: &#123;<br>    &quot;properties&quot;: &#123;<br>      &quot;fieldName&quot;: &#123;<br>        &quot;type&quot;: &quot;text&quot;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>在已有的索引上创建映射</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /my-index/_mapping<br>&#123;<br>  &quot;properties&quot;: &#123;<br>    &quot;fieldName&quot;: &#123;<br>      &quot;type&quot;: &quot;text&quot;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<p>创建索引使用到的参数也不用刻意去记，当第一个文档路径被成功创建之后，Elasticsearch 会根据数据结构自动推断出映射。之后，我们只需要根据自己的需求，修改对应的参数即可，比如：分词设置、分析器设置等。</p>
<p>另外，每个字段中还可以再定义<code>properties</code>配置，以此来构建一个复杂的数据结构。</p>
<h3 id="修改映射"><a href="#修改映射" class="headerlink" title="修改映射"></a>修改映射</h3><blockquote>
<p>注意：这里的修改只是修改了字段的索引方式，其它不能修改。索引的 Mapping 字段只能追加，不能删除和类型修改。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /my-index/_mapping<br>&#123;<br>  &quot;properties&quot;: &#123;<br>    &quot;fieldName&quot;: &#123;<br>      &quot;type&quot;: &quot;text&quot;,<br>      &quot;fields&quot;: &#123;<br>        &quot;keyword&quot;: &#123;<br>          &quot;type&quot;: &quot;keyword&quot;,<br>          &quot;ignore_above&quot;: 256<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>从执行指令上来看，不难发现修改映射和添加映射一样，都是使用的 PUT 方法。当映射不存在时会创建一个新的映射，当映射存在时会对其进行修改。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><blockquote>
<p>结合上面的内容不难看出，在 Elasticsearch 中，所有涉及到结构层面的东西是不能修改的。比如主分片、映射等，因为这些修改会导致数据不完整，因此不支持修改。如果想要修改，只能够通过重建索引来实现。</p>
<p>建议：在使用 Elasticsearch 之前，应当规划好索引并且设计好数据结构。因为就算是 Elasticsearch 支持索引的迁移，这也会给运维的过程增加很多负担，因为每次的索引迁移都需要关闭索引的写入，这也就导致一段时间内，某些功能将不可用。</p>
<p>除此之外，对于数据量非常庞大，并且允许冷热分离的索引，建议采用一对多别名的方式来使用。可以使用时间维度将数据分成多个索引，随着时间的增长逐步增加。然后将别名与一定时间范围内的索引进行绑定来控制查询范围，比如只允许查询三个月内的数据，其他数据只能后台查询。</p>
</blockquote>
<h2 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h2><blockquote>
<p>Elasticsearch 的文档类似关系型数据库中的一行记录，是日常开发过程中使用最多的操作。因此，文档的操作也是 Elasticsearch 学习的重点。</p>
</blockquote>
<h3 id="创建文档"><a href="#创建文档" class="headerlink" title="创建文档"></a>创建文档</h3><p>要创建一个文档，需要向 Elasticsearch 的一个索引中添加一个 JSON 格式的文档。虽然 Elasticsearch 支持在第一次创建文档时同步创建索引。但如果想要对索引进行设置，比如主分片数量、固定映射字段等操作，就必须先创建好文档再写入数据，因为同步创建索引时使用的是 Elasticsearch 默认值。</p>
<p>下面是一个创建文档的简单示例：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /my_index/_doc/1<br>&#123;<br>  &quot;title&quot;: &quot;Elasticsearch文档&quot;,<br>  &quot;content&quot;: &quot;Elasticsearch 是一个分布式的全文搜索和分析引擎，它能够帮助用户存储、搜索和分析海量的数据。&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这个例子中，使用了 PUT 请求将一个 JSON 格式的文档添加到名为“my_index”的索引中，该文档的 ID 为“1”。文档包含两个字段：“title”和“content”。</p>
<p>在创建文档时，可以选择为文档指定一个唯一的 ID，或者让 Elasticsearch 自动生成一个唯一的 ID。如果您未指定文档 ID，则 Elasticsearch 会自动生成一个唯一的 ID。</p>
<p>除了使用 PUT 请求之外，还可以使用 POST 请求创建文档。例如：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/my_index/</span>_doc<br>&#123;<br>  <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;Elasticsearch文档&quot;</span>,<br>  <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;Elasticsearch 是一个分布式的全文搜索和分析引擎，它能够帮助用户存储、搜索和分析海量的数据。&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>在这种情况下，Elasticsearch 会自动生成一个唯一的 ID，并将文档添加到名为“my_index”的索引中。</p>
<p>注意，如果尝试添加一个具有相同 ID 的文档，则 Elasticsearch 会将新文档替换旧文档。如果您希望将文档添加到索引中而不是替换旧文档，则可以使用 POST 请求，并将“_id”字段设置为一个新的唯一值。</p>
<p>在 Elasticsearch 中，PUT 和 POST 请求都可以用来创建新文档，但它们之间有一些重要的区别：</p>
<ul>
<li>PUT 请求必须指定文档 ID，而 POST 请求可以让 Elasticsearch 自动生成文档 ID。</li>
<li>PUT 请求是幂等的，即重复调用同一个 PUT 请求多次不会导致数据的变化，而 POST 请求不是幂等的。</li>
</ul>
<h3 id="版本号"><a href="#版本号" class="headerlink" title="版本号"></a>版本号</h3><p>每个文档都有一个版本号，使用版本号参数可以达到并发控制的效果。</p>
<p><strong>查询版本号</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /my_index/_doc/1<br></code></pre></td></tr></table></figure>

<p>这里查询出 ID 为 1 的文档，返回内容如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;my_index&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_seq_no&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_primary_term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;found&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Elasticsearch文档ssss&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Elasticsearch 是一个分布式的全文搜索和分析引擎，它能够帮助用户存储、搜索和分析海量的数据。&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>这里有三个重要的信息：</p>
<ul>
<li>_version：它是 Elasticsearch 的内部版本号，是 Elasticsearch 在创建或更新文档时自动分配的，也是 Elasticsearch 内部控制幂等的机制，不能作为乐观锁来使用。</li>
<li>_seq_no：文档序列号，这是一个外部版本，每次修改文档序列号都会增加。它可以作为乐观锁来控制并发操作。</li>
<li>_primary_term：文档所在的分片号，Elasticsearch 的索引是支持分片的，数据放在哪个分片上是有 Elasticsearch 决定的。因此，使用序列号控制并发操作时，需要向 Elasticsearch 说明文档在哪个分片上。</li>
</ul>
<p>比如我们在修改数据的时候，使用版本号来控制并发，如下：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /my_index/_doc/1?if_seq_no=8&amp;if_primary_term=1<br>&#123;<br>  &quot;title&quot;: &quot;Elasticsearch文档ssss&quot;,<br>  &quot;content&quot;: &quot;Elasticsearch 是一个分布式的全文搜索和分析引擎，它能够帮助用户存储、搜索和分析海量的数据。&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>命令执行后，返回数据如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;my_index&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">9</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;result&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;updated&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_seq_no&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">9</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_primary_term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>当再次执行命令时，返回结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;error&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;root_cause&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;version_conflict_engine_exception&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;reason&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;[1]: version conflict, required seqNo [8], primary term [1]. current document has seqNo [9] and primary term [1]&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;index_uuid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;qNAAFgvPRpWhEjea30PAow&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;shard&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;my_index&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;version_conflict_engine_exception&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;reason&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;[1]: version conflict, required seqNo [8], primary term [1]. current document has seqNo [9] and primary term [1]&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;index_uuid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;qNAAFgvPRpWhEjea30PAow&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;shard&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;my_index&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">409</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>这是会看到报错信息，其中有一段信息内容为<code>version conflict, required seqNo [8], primary term [1]. current document has seqNo [9] and primary term [1]</code>。这段话的大致意思是请求的序列号为 8，但当前文档的序列号是 9。这和我们在使用关系型数据库时，通过查询版本号控制幂等几乎是一样的。</p>
<h3 id="修改文档"><a href="#修改文档" class="headerlink" title="修改文档"></a>修改文档</h3><blockquote>
<p>注意：上面提到创建文档之后，再次使用命令进行操作会对文档进行修改。这里的修改实际上是覆盖数据。</p>
<p>比如我们执行</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /my_index/_doc/1<br>&#123;<br>  &quot;title&quot;: &quot;Elasticsearch文档ssss&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>那么 ID 为 1 的文档将会被新文档覆盖，当再次查询时，会发现<code>content</code>字段没有了。因此我们在修改文档时，尽可能使用部分修改，即只修改列举出的字段。尽可能不要使用覆盖操作。</p>
</blockquote>
<p>Elasticsearch 支持两种文档的修改方式，并且更新只能使用 POST 方式，另外从示例中可以看出，局部修改时也可以使用序列号来进行并发控制。</p>
<ul>
<li><p>局部文档更新</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs http">POST /my_index/_update/1?if_seq_no=15&amp;if_primary_term=1<br>&#123;<br>  &quot;doc&quot;: &#123;<br>    &quot;title&quot;: &quot;Elasticsearch文档局部更新2&quot;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>使用脚本更新文档</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs http">POST /my_index/_update/1?if_seq_no=16&amp;if_primary_term=1<br>&#123;<br>  &quot;script&quot;: &#123;<br>    &quot;source&quot;: &quot;ctx._source.title = &#x27;Elasticsearch文档脚本更新&#x27;&quot;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Elasticsearch 脚本使用的是<code>Painless</code>语言，它的语法类似<code>Groovy</code>语言，是 Java 的扩展脚本。因此这里可以直接使用它的语法来做更深入的操作。</p>
<p>比如：我们在修改的时候，文档内所有的英文改成大写。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs http">POST /my_index/_update/1?if_seq_no=17&amp;if_primary_term=1<br>&#123;<br>  &quot;script&quot;: &#123;<br>    &quot;source&quot;: &quot;ctx._source.title = &#x27;Elasticsearch文档脚本更新&#x27;.toUpperCase()&quot;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里可以看到，字符串后面调用了一个<code>toUpperCase()</code>方法。</p>
</li>
</ul>
<p><strong>按条件修改</strong></p>
<p>除了上面提到的根据 ID 修改文档外，也可以根据条件来修改。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs http">POST /my_index/_update_by_query<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;match&quot;: &#123;<br>      &quot;title.keyword&quot;: &quot;Elasticsearch文档2&quot;<br>    &#125;<br>  &#125;,<br>  &quot;script&quot;: &#123;<br>    &quot;source&quot;: &quot;ctx._source.title = ctx._source.title + &#x27;条件修改&#x27;&quot;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>条件修改是一个非常危险的操作，并且一旦修改文档就无法恢复。尤其是该条件字段在 Elasticsearch 中被分词了，这将会导致所有分词匹配的数据都会被修改。</p>
<p>因此，如果想要使用条件修改就一定要将条件进行精准匹配。如果字段被分词可以在查询字段的后面加上<code>.keyword</code>来精准查询，如果字段没有被分词，可以将<code>match</code>替换成<code>term</code>。</p>
<p>另外，按条件修改只能通过脚本方式修改，不支持局部更新的方式来修改。如果想要修改多个字段，可以使用 params。比如下面这个例子：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs http">POST /my_index/_update_by_query<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;match&quot;: &#123;<br>      &quot;title.keyword&quot;: &quot;Elasticsearch文档2&quot;<br>    &#125;<br>  &#125;,<br>  &quot;script&quot;: &#123;<br>    &quot;source&quot;: &quot;ctx._source.title = params.title; ctx._source.content = params.content&quot;,<br>    &quot;params&quot;: &#123;<br>      &quot;title&quot;: &quot;Elasticsearch文档2条件修改&quot;,<br>      &quot;content&quot;: &quot;Elasticsearch 是一个分布式的全文搜索和分析引擎&quot;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>params 中定义了修改的参数，然后在 source 中使用语法拼接，或在 source 中使用数组来定义每一个需要更新的字段。</p>
<h3 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h3><p>删除文档时，可以根据 ID 来删除，也可以根据条件来删除。</p>
<ul>
<li><p>根据 ID 删除</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">DELETE /my_index/_doc/1<br></code></pre></td></tr></table></figure>
</li>
<li><p>按条件删除</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs http">POST /my_index/_delete_by_query<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;match&quot;: &#123;<br>      &quot;title.keyword&quot;: &quot;Elasticsearch文档2&quot;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>条件删除是一个非常危险的操作，并且一旦删除文档就无法恢复。尤其是该条件字段在 Elasticsearch 中被分词了，这将会导致所有分词匹配的数据都会被删除。</p>
<p>因此，如果想要使用条件删除就一定要将条件进行精准匹配。如果字段被分词可以在查询字段的后面加上<code>.keyword</code>来精准查询，如果字段没有被分词，可以将<code>match</code>替换成<code>term</code>。</p>
</li>
</ul>
<h3 id="查询文档"><a href="#查询文档" class="headerlink" title="查询文档"></a>查询文档</h3><p>以下是 Elasticsearch 常用的一些查询类型：</p>
<ul>
<li>match 查询：该查询将在指定的字段中搜索包含给定单词或短语的文档。它支持模糊匹配和距离计算，并且可以与不同的运算符（如 AND 和 OR）结合使用。</li>
<li>term 查询：该查询将在指定字段中查找包含指定术语的文档。它是精确匹配，不会分词查询字符串，而是在原始文本上执行匹配。</li>
<li>range 查询：该查询将返回指定范围内的文档。可以指定数字、日期和其他类型的范围。</li>
<li>bool 查询：该查询将允许你组合多个查询条件，使用布尔运算符进行联合，例如 AND、OR 和 NOT。</li>
<li>prefix 查询：该查询将在指定字段中搜索以给定前缀开头的文档。</li>
<li>wildcard 查询：该查询将在指定字段中搜索匹配给定通配符模式的文档。</li>
<li>fuzzy 查询：该查询将在指定字段中搜索与给定单词类似的文档，支持模糊匹配。</li>
<li>match_phrase 查询：该查询将在指定字段中搜索包含给定短语的文档，但短语必须以相同的顺序和连续出现。</li>
<li>match_all 查询：该查询将返回所有文档，可以用于不带任何搜索条件的查询，但是需要指定索引名称。</li>
<li>multi_match 查询：该查询将在多个字段中搜索包含指定单词或短语的文档。</li>
</ul>
<p>下面开始说明一些常用的查询案例</p>
<h4 id="查询所有"><a href="#查询所有" class="headerlink" title="查询所有"></a>查询所有</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /my_index/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;match_all&quot;: &#123;&#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>也可以直接使用</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /my_index/_search<br></code></pre></td></tr></table></figure>

<h4 id="查询时返回指定字段"><a href="#查询时返回指定字段" class="headerlink" title="查询时返回指定字段"></a>查询时返回指定字段</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /my_index/_search<br>&#123;<br>  &quot;_source&quot;: [&quot;title&quot;, &quot;content&quot;]<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="单条件查询"><a href="#单条件查询" class="headerlink" title="单条件查询"></a>单条件查询</h4><p>比如查询<code>title</code>字段：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /my_index/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;match&quot;: &#123;<br>      &quot;title&quot;: &quot;Elasticsearch&quot;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="多条件-AND-查询"><a href="#多条件-AND-查询" class="headerlink" title="多条件 AND 查询"></a>多条件 AND 查询</h4><p>比如查询<code>title</code>和<code>content</code>都包含某个值：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /my_index/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;bool&quot;: &#123;<br>      &quot;must&quot;: [<br>        &#123;<br>          &quot;match&quot;: &#123;<br>            &quot;title&quot;: &quot;Elasticsearch&quot;<br>          &#125;<br>        &#125;,<br>        &#123;<br>          &quot;match&quot;: &#123;<br>            &quot;content&quot;: &quot;Elasticsearch&quot;<br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="多条件-OR-查询"><a href="#多条件-OR-查询" class="headerlink" title="多条件 OR 查询"></a>多条件 OR 查询</h4><p><code>multi_match</code>：多匹配方式。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">GET /my_index/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;multi_match&quot;: &#123;<br>      &quot;query&quot;: &quot;1&quot;,<br>      &quot;fields&quot;: [&quot;title&quot;, &quot;content&quot;]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>should</code>：布尔方式。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /my_index/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;bool&quot;: &#123;<br>      &quot;should&quot;: [<br>        &#123;<br>          &quot;match&quot;: &#123;<br>            &quot;title&quot;: &quot;1&quot;<br>          &#125;<br>        &#125;,<br>        &#123;<br>          &quot;match&quot;: &#123;<br>            &quot;content&quot;: &quot;1&quot;<br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="范围查询"><a href="#范围查询" class="headerlink" title="范围查询"></a>范围查询</h4><p>比如文档中有一个<code>price</code>字段，查询价格在<code>25.00</code>到<code>50.00</code>的数据。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /my_index/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;range&quot;: &#123;<br>      &quot;price&quot;: &#123;<br>        &quot;gte&quot;: 25,<br>        &quot;lte&quot;: 50<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="分页查询"><a href="#分页查询" class="headerlink" title="分页查询"></a>分页查询</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /my_index/_search<br>&#123;<br>  &quot;from&quot;: 0,<br>  &quot;size&quot;: 10<br>&#125;<br></code></pre></td></tr></table></figure>

<p>参数说明：</p>
<ul>
<li>from：页索引，即：(页码 - 1) * 页大小。</li>
<li>size：页大小。</li>
</ul>
<h4 id="查询排序"><a href="#查询排序" class="headerlink" title="查询排序"></a>查询排序</h4><p>比如按照价格降序</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /my_index/_search<br>&#123;<br>  &quot;sort&quot;: [<br>    &#123;<br>      &quot;price&quot;: &#123;<br>        &quot;order&quot;: &quot;desc&quot;<br>      &#125;<br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="查询总记录数"><a href="#查询总记录数" class="headerlink" title="查询总记录数"></a>查询总记录数</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /my_index/_count<br></code></pre></td></tr></table></figure>

<h4 id="模糊查询"><a href="#模糊查询" class="headerlink" title="模糊查询"></a>模糊查询</h4><p>模糊查询有很多种方式，这里介绍两个常用的。但由于模糊查询对性能的损耗较高，通常情况下不建议模糊查询，而尽可能给予分词搜索。</p>
<ul>
<li><p>使用通配符进行模糊查询</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /my_index/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;wildcard&quot;: &#123;<br>      &quot;content.keyword&quot;: &#123;<br>        &quot;value&quot;: &quot;*se?rch*&quot;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>匹配说明：</p>
<p>*：表示忽略匹配的内容，也可以理解为模糊位置。</p>
<p>?：是占位符，比如<code>*se?rch*</code>中，<code>se</code>和<code>rch</code>中间有一个字符可以任意。有几个?表示有几个任意字符。</p>
</li>
<li><p>使用相似度进行模糊查询</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /my_index/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;fuzzy&quot;: &#123;<br>      &quot;content&quot;: &#123;<br>        &quot;value&quot;: &quot;海量&quot;,<br>        &quot;fuzziness&quot;: 1<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>重要参数说明：</p>
<ul>
<li>fuzziness：fuzziness 参数用于控制模糊查询的容错率。它指定了查询时能够容忍的最大编辑距离，即允许查询中的单词和目标词之间的最大差异量。其中 1 表示容忍一个字符的差异，值越大匹配度越高，但相对的查询出的数据越不精准。</li>
</ul>
</li>
</ul>
<h2 id="分词器"><a href="#分词器" class="headerlink" title="分词器"></a>分词器</h2><blockquote>
<p>Elasticsearch 安装完成后，默认只有一个分词器<code>standard</code>。这是一个标准分词器，它可以对英文进行很好的分词处理。但是如果使用中文查询，他会将每一个字分成一个词，这对 Elasticsearch 的损耗相当大，因此需要安装一个中文分词器来处理。</p>
<p>常用的分词是 ik 中文分词器。</p>
</blockquote>
<p>ik 分词器有以下几种常用的分词方式：</p>
<ul>
<li>ik_smart：智能分词，可以将一些较复杂的词汇进行正确地拆分。</li>
<li>ik_max_word：细粒度分词，会将所有可能的词语都进行切分，速度较慢，但精度较高。</li>
<li>ik_word：粗粒度分词，会将一些常见的词语组合在一起，速度较快，但精度较低。</li>
<li>ik_pinyin：拼音分词，将汉字转换成拼音，并进行切分。</li>
<li>ik_synonym：同义词分词，根据自定义的同义词词典进行分词。</li>
<li>ik_english：英文分词，对英文文本进行分词。</li>
</ul>
<h3 id="安装-IK-分词器"><a href="#安装-IK-分词器" class="headerlink" title="安装 IK 分词器"></a>安装 IK 分词器</h3><blockquote>
<p>分词器的版本要和 Elasticsearch 的版本一致，否则无法启动。</p>
</blockquote>
<h4 id="下载插件包"><a href="#下载插件包" class="headerlink" title="下载插件包"></a>下载插件包</h4><ul>
<li><p>下载分词器包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.17.7/elasticsearch-analysis-ik-7.17.7.zip<br></code></pre></td></tr></table></figure>

<p>如果使用<code>wget</code>下载比较慢，也可以下载到本地电脑，然后上传到服务器。</p>
</li>
</ul>
<h4 id="安装分词器"><a href="#安装分词器" class="headerlink" title="安装分词器"></a>安装分词器</h4><ul>
<li><p>解压分词器包到插件目录</p>
<p>这里将插件包解压到了插件目录下的<code>ik</code>目录，<code>ik</code>目录无需提前创建，解压时会自动创建。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">unzip ~/elasticsearch-analysis-ik-7.17.7.zip -d ~/elasticsearch/plugins/ik/<br></code></pre></td></tr></table></figure>
</li>
<li><p>给 ik 目录授权</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">chmod o+xrw -R ~/elasticsearch/plugins/ik/<br></code></pre></td></tr></table></figure>
</li>
<li><p>指定 ik 目录的所属用户</p>
<p>前面我们已经给插件目录设置所属用户了，由于 ik 目录是后创建的，所以需要重新设置一次。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">chown 1000 -R ~/elasticsearch/plugins/ik/<br></code></pre></td></tr></table></figure>
</li>
<li><p>重新启动 Elasticsearch 集群</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker-compose -f ~/elasticsearch/elasticsearch-compose.yml restart<br></code></pre></td></tr></table></figure>

<p>重启后，可以使用<code>watch docker ps</code>监控一段时间，如果一切正常说明重启成功。</p>
</li>
<li><p>检查分词器是否生效</p>
<p>选择任意一个 Elasticsearch 节点容器进入。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker exec -it &lt;容器ID&gt; /bin/bash<br></code></pre></td></tr></table></figure>

<p>成功进入容器后，使用<code>elasticsearch-plugin</code>命令查看当前的插件列表。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">elasticsearch-plugin list<br></code></pre></td></tr></table></figure>

<p>命令执行结果如下：</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs arcade">-- <span class="hljs-built_in">console</span> <span class="hljs-built_in">log</span> --<br>ik<br></code></pre></td></tr></table></figure>

<p>到这里可以看到，已经安装了一个 ik 插件。</p>
</li>
</ul>
<h4 id="使用案例"><a href="#使用案例" class="headerlink" title="使用案例"></a>使用案例</h4><p>我们可以使用 Elasticsearch de <code>_analyze</code>命令来分析一段话，来测试中文分词的具体效果。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs http">GET _analyze<br>&#123;<br>  &quot;analyzer&quot;: &quot;ik_smart&quot;,<br>  &quot;text&quot;: &quot;高性能的全文搜索引擎。&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>命令执行结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;tokens&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;token&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;高性能&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;start_offset&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;end_offset&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;CN_WORD&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;position&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;token&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;的&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;start_offset&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;end_offset&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;CN_CHAR&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;position&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;token&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;全文&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;start_offset&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;end_offset&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;CN_WORD&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;position&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;token&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;搜索引擎&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;start_offset&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;end_offset&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;CN_WORD&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;position&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>从执行结果可以看到，关键词被分成了一个完整的词，而不是一个字一个词。</p>
<p>如果使用默认的<code>standard</code>分词器，会看到中文被分成了一个字一个词。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Elasticsearch/" class="category-chain-item">Elasticsearch</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Elasticsearch/">#Elasticsearch</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Elasticsearch 学习笔记</div>
      <div>https://kael.52dev.fun/2023/04/21/Elastic Search 学习笔记/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Kael</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年4月21日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              BY (KAEL)
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/04/20/%E6%90%AD%E5%BB%BAJenkins%E7%8E%AF%E5%A2%83/" title="如何搭建 Jenkins 环境">
                        <span class="hidden-mobile">如何搭建 Jenkins 环境</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <div><b>码农卡尔的笔记</b></div> <div>联系邮箱: kael3805@gmail.com</div> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
